# @configure_input@

# Package-related substitution variables
package	= @PACKAGE_NAME@
version	= @PACKAGE_VERSION@
tarname	= @PACKAGE_TARNAME@
distdir	= $(tarname)-$(version)

# Prefix-related substitution variables
prefix	 = @prefix@
exec_prefix    = @exec_prefix@
bindir	 = @bindir@
libdir	 = @libdir@

# Tool-related substitution variables
CXX		         = @CXX@
CXXFLAGS       = @CXXFLAGS@
LIBS	         = @LIBS@
DEFS           = @DEFS@
INSTALL	       = @INSTALL@
INSTALL_DATA   = @INSTALL_DATA@
INSTALL_PROGRAM= @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@
CUDA_CFLAGS    = @CUDA_CFLAGS@
CUDA_LIBS      = @CUDA_LIBS@
CUDA_LDFLAGS   = @CUDA_LDFLAGS@
NVCC       	   = @NVCC@
MPI_INC        = @MPI_INC@
MPI_LIBDIR     = @MPI_LIBDIR@
MPI_LIBS       = @MPI_LIBS@

# VPATH-related substitution variables
srcdir	 = @srcdir@
VPATH	  = @srcdir@

LIBOBJS=sparseCpuKernels.o io.o denseCpuKernels.o mapDistanceFunctions.o training.o uMatrix.o

ifdef CUDA_LIBS
	LIBOBJS+=denseGpuKernels.cu.co
endif

OBJS=$(LIBOBJS) somoclu.o

all: somoclu

lib: $(LIBOBJS)
	$(CXX) $(DEFS) $(CXXFLAGS) $(CUDA_LDFLAGS) ${MPI_LIBDIR} -shared -o libsomoclu.so $^ $(LIBS) $(CUDA_LIBS) ${MPI_LIBS}
	
somoclu: CXXFLAGS+= -DCLI
somoclu: $(OBJS)
	$(CXX) $(DEFS) $(CXXFLAGS) $(CUDA_LDFLAGS) ${MPI_LIBDIR} -o $@ $^ $(LIBS) $(CUDA_LIBS) ${MPI_LIBS}

%.o: %.cpp
		$(CXX) $(DEFS) $(CXXFLAGS) ${MPI_INC} -I$(srcdir) -I.. -o $@ -c $(srcdir)/$<

%.cu.co: %.cu
		$(NVCC) $(DEFS) $(CUDA_CFLAGS) ${MPI_INC} -I$(srcdir) -I.. -o $@ -c $(srcdir)/$<

python_clean:
	-rm -fr ./Python/somoclu/m4 ./Python/somoclu/src ./Python/somoclu/autogen.sh ./Python/somoclu/Makefile* ./Python/somoclu/config* ./Python/somoclu/*so ./Python/somoclu/*c ./Python/somoclu/*cxx ./Python/somoclu/LICENSE ./Python/dist ./Python/build $(OBJS) 1>/dev/null

python:
	mkdir -p ./Python/somoclu/src
	mkdir -p ./Python/somoclu/src/Windows
	cp -R ../m4 ./Python/somoclu/
	cp ../autogen.sh ./Python/somoclu/
	cp ../LICENSE ./Python/somoclu/
	cp ../Makefile.in ./Python/somoclu/
	cp ../configure.ac ./Python/somoclu/
	cp ./Makefile.in ./Python/somoclu/src/
	cp ./*.h ./Python/somoclu/src/
	cp ./*.cpp ./Python/somoclu/src/
	cp ./*.cu ./Python/somoclu/src/
	swig -c++ -python ./Python/somoclu/somoclu.i
	cd Python; python setup.py build

python_install: python
	cd Python; python setup.py install

r_clean:
	-rm -fr ./R/src/*h ./R/src/mapDistanceFunctions.cpp ./R/src/training.cpp ./R/src/uMatrix.cpp ./R/src/denseCpuKernels.cpp ./R/src/sparseCpuKernels.cpp R/data ./Rsomoclu*gz

r:
	mkdir -p R/data
	cp ./*.h ./R/src/
	cp ./mapDistanceFunctions.cpp ./R/src/
	cp ./training.cpp ./R/src/
	cp ./uMatrix.cpp ./R/src/
	cp ./denseCpuKernels.cpp ./R/src/
	cp ./sparseCpuKernels.cpp ./R/src/
	cp ../data/rgbs.txt ./R/data/
	gzip ./R/data/rgbs.txt 
	R CMD build R

clean:
	-rm -fr somoclu libsomoclu.so 1>/dev/null

install:
	$(INSTALL) -d $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) -m 0755 somoclu \
	 $(DESTDIR)$(bindir)
	 
uninstall:
	-rm $(DESTDIR)$(bindir)/somoclu &>/dev/null

Makefile: Makefile.in ../config.status
	cd .. && ./config.status $@

../config.status: ../configure
	cd .. && ./config.status --recheck

.PHONY: all clean install uninstall
